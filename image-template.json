{
  "type": "Microsoft.VirtualMachineImages/imageTemplates",
  "apiVersion": "2022-02-14",
  "location": "NorthCentralUS",
  "identity": {
    "type": "UserAssigned",
    "userAssignedIdentities": {
      "/subscriptions/7c58d880-5fa8-46e0-809e-31e1bb700d40/resourcegroups/finalpocgroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/mi001": {}
    }
  },
  "properties": {
    "source": {
      "type": "SharedImageVersion",
      "imageVersionId": "/subscriptions/7c58d880-5fa8-46e0-809e-31e1bb700d40/resourceGroups/finalpocgroup/providers/Microsoft.Compute/galleries/gal1/images/vmdef1/versions/0.0.0"
    },
    "customize": [
      {
        "type": "Shell",
        "name": "UpdateSystemAndDependencies",
        "inline": [
          "echo 'üîπ Updating system packages...'",
          "sudo apt-get update -y",
          "sudo apt-get install -y nodejs npm unzip curl"
        ]
      },
      {
        "type": "Shell",
        "name": "StopExistingApp",
        "inline": [
          "echo 'üîπ Stopping existing application...'",
          "pm2 stop helloapp || true",
          "pm2 delete helloapp || true"
        ]
      },
      {
        "type": "Shell",
        "name": "UpdateApplication",
        "inline": [
          "set -e",
          "echo 'üîπ Setting up application directory...'",
          "APP_DIR=/var/www/helloapp",
          "sudo mkdir -p $APP_DIR",
          "sudo rm -rf $APP_DIR/*",
          "echo 'üîπ Checking if application artifact exists...'",
          "cd /tmp",
          "echo 'üîπ Testing blob storage connectivity...'",
          "if sudo curl --head --silent --fail 'https://shubhstac.blob.core.windows.net/artifacts/app.zip' > /dev/null 2>&1; then",
          "  echo '‚úÖ Blob is accessible'",
          "  echo 'üîπ Downloading new application version...'",
          "  sudo curl -f -v -o app.zip 'https://shubhstac.blob.core.windows.net/artifacts/app.zip' || (echo '‚ùå Download failed' && exit 1)",
          "  echo 'üîπ Verifying download...'",
          "  ls -la app.zip",
          "  file app.zip",
          "  echo 'üîπ Extracting application...'",
          "  sudo unzip -o app.zip || (echo '‚ùå Unzip failed' && exit 1)",
          "  sudo rm app.zip",
          "  echo 'üîπ Listing extracted files...'",
          "  ls -la",
          "  echo 'üîπ Copying build artifacts...'",
          "  sudo cp -r * $APP_DIR/ || (echo '‚ùå Copy failed' && exit 1)",
          "  cd $APP_DIR",
          "  echo 'üîπ Files in app directory:'",
          "  ls -la",
          "  echo 'üîπ Installing dependencies...'",
          "  sudo npm install || (echo '‚ùå npm install failed' && exit 1)",
          "  echo 'üîπ Setting correct permissions...'",
          "  sudo chown -R $USER:$USER $APP_DIR",
          "  echo '‚úÖ Application updated successfully!'",
          "else",
          "  echo '‚ùå Blob not accessible - check storage account permissions'",
          "  echo 'üîπ Creating placeholder structure...'",
          "  cd $APP_DIR",
          "  echo '{\"name\": \"placeholder\", \"version\": \"0.0.0\"}' | sudo tee package.json > /dev/null",
          "  echo 'console.log(\"Placeholder app - waiting for real deployment\");' | sudo tee server.js > /dev/null",
          "  sudo chown -R $USER:$USER $APP_DIR",
          "  echo '‚úÖ Placeholder structure created!'",
          "fi"
        ]
      },
      {
        "type": "Shell",
        "name": "SetupPM2AndStartApp",
        "inline": [
          "echo 'üîπ Installing PM2 globally...'",
          "sudo npm install -g pm2",
          "APP_DIR=/var/www/helloapp",
          "cd $APP_DIR",
          "echo 'üîπ Checking if real application exists...'",
          "if [ -f server.js ] && [ ! $(grep -q 'Placeholder app' server.js; echo $?) -eq 0 ]; then",
          "  echo 'üîπ Starting real app with PM2...'",
          "  pm2 start server.js --name helloapp || pm2 restart helloapp",
          "  echo 'üîπ Setting up PM2 startup...'",
          "  pm2 startup systemd -u $USER --hp $HOME --silent",
          "  pm2 save",
          "  echo '‚úÖ Real application started successfully!'",
          "else",
          "  echo '‚ö†Ô∏è  Placeholder app detected - PM2 setup prepared but not started'",
          "  echo 'üîπ Setting up PM2 startup for future use...'",
          "  pm2 startup systemd -u $USER --hp $HOME --silent",
          "  echo '‚úÖ PM2 configured for future deployments!'",
          "fi"
        ]
      },
      {
        "type": "Shell",
        "name": "VerifyApplication",
        "inline": [
          "echo 'üîπ Verifying application installation...'",
          "APP_DIR=/var/www/helloapp",
          "ls -la $APP_DIR/",
          "echo 'üîπ Checking required files exist...'",
          "test -f $APP_DIR/package.json && echo 'package.json found' || echo 'ERROR: package.json missing'",
          "test -f $APP_DIR/server.js && echo 'server.js found' || echo 'ERROR: server.js missing'",
          "test -d $APP_DIR/node_modules && echo 'node_modules found' || echo 'ERROR: node_modules missing'",
          "echo 'üîπ Checking PM2 process...'",
          "pm2 list | grep helloapp && echo 'PM2 process running' || echo 'WARNING: PM2 process not found'",
          "echo '‚úÖ Verification completed!'"
        ]
      }
    ],
    "distribute": [
      {
        "type": "SharedImage",
        "galleryImageId": "/subscriptions/7c58d880-5fa8-46e0-809e-31e1bb700d40/resourceGroups/finalpocgroup/providers/Microsoft.Compute/galleries/gal1/images/vmdef1/versions/PLACEHOLDER_VERSION",
        "runOutputName": "updatedAppImage",
        "replicationRegions": ["NorthCentralUS"],
        "excludeFromLatest": false
      }
    ],
    "vmProfile": {
      "vmSize": "Standard_B2s",
      "osDiskSizeGB": 32
    },
    "buildTimeoutInMinutes": 60
  }
}
 
