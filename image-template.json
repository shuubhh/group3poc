{
  "type": "Microsoft.VirtualMachineImages/imageTemplates",
  "apiVersion": "2022-02-14",
  "location": "NorthCentralUS",
  "identity": {
    "type": "UserAssigned",
    "userAssignedIdentities": {
      "/subscriptions/7c58d880-5fa8-46e0-809e-31e1bb700d40/resourcegroups/finalpocgroup/providers/Microsoft.ManagedIdentity/userAssignedIdentities/mi001": {}
    }
  },
  "properties": {
    "source": {
      "type": "SharedImageVersion",
      "imageVersionId": "/subscriptions/7c58d880-5fa8-46e0-809e-31e1bb700d40/resourceGroups/finalpocgroup/providers/Microsoft.Compute/galleries/gal1/images/vmdef1/versions/0.0.0"
    },
    "customize": [
      {
        "type": "Shell",
        "name": "UpdateSystemAndDependencies",
        "inline": [
          "echo 'ðŸ”¹ Updating system packages...'",
          "sudo apt-get update -y"
        ]
      },
      {
        "type": "Shell",
        "name": "StopExistingApp",
        "inline": [
          "echo 'ðŸ”¹ Stopping existing application...'",
          "pm2 stop helloapp || true",
          "pm2 delete helloapp || true"
        ]
      },
      {
        "type": "Shell",
        "name": "UpdateApplication",
        "inline": [
          "set -e",
          "APP_DIR=/var/www/helloapp",
          "echo 'ðŸ”¹ Creating clean application directory...'",
          "sudo mkdir -p $APP_DIR",
          "sudo rm -rf $APP_DIR/*",
 
          "echo 'ðŸ”¹ Downloading app.zip from blob storage...'",
          "az storage blob download --account-name shubhstac --container-name artifacts --name app.zip --file /tmp/app.zip --auth-mode login",
 
          "echo 'ðŸ”¹ Extracting application into $APP_DIR ...'",
          "sudo unzip -o /tmp/app.zip -d $APP_DIR",
          "rm /tmp/app.zip",
 
          "echo 'ðŸ”¹ Installing dependencies...'",
          "cd $APP_DIR",
          "sudo npm install --production",
 
          "echo 'ðŸ”¹ Fixing permissions...'",
          "sudo chown -R $USER:$USER $APP_DIR",
 
          "echo 'âœ… Application updated successfully!'"
        ]
      },
      {
        "type": "Shell",
        "name": "SetupPM2AndStartApp",
        "inline": [
          "echo 'ðŸ”¹ Installing PM2 globally...'",
          "sudo npm install -g pm2",
          "APP_DIR=/var/www/helloapp",
          "cd $APP_DIR",
          "echo 'ðŸ”¹ Starting app with PM2...'",
          "pm2 start server.js --name helloapp || pm2 restart helloapp",
          "echo 'ðŸ”¹ Enabling PM2 startup...'",
          "pm2 startup systemd -u $USER --hp $HOME --silent",
          "pm2 save",
          "echo 'âœ… App started successfully!'"
        ]
      },
      {
        "type": "Shell",
        "name": "VerifyApplication",
        "inline": [
          "echo 'ðŸ”¹ Verifying application installation...'",
          "APP_DIR=/var/www/helloapp",
          "ls -la $APP_DIR/",
          "test -f $APP_DIR/package.json && echo 'package.json found' || echo 'ERROR: package.json missing'",
          "test -f $APP_DIR/server.js && echo 'server.js found' || echo 'ERROR: server.js missing'",
          "test -d $APP_DIR/node_modules && echo 'node_modules found' || echo 'ERROR: node_modules missing'",
          "pm2 list | grep helloapp && echo 'PM2 process running' || echo 'WARNING: PM2 process not found'",
          "echo 'âœ… Verification completed!'"
        ]
      }
    ],
    "distribute": [
      {
        "type": "SharedImage",
        "galleryImageId": "/subscriptions/7c58d880-5fa8-46e0-809e-31e1bb700d40/resourceGroups/finalpocgroup/providers/Microsoft.Compute/galleries/gal1/images/vmdef1/versions/PLACEHOLDER_VERSION",
        "runOutputName": "updatedAppImage",
        "replicationRegions": ["NorthCentralUS"],
        "excludeFromLatest": false
      }
    ],
    "vmProfile": {
      "vmSize": "Standard_B2s",
      "osDiskSizeGB": 32
    },
    "buildTimeoutInMinutes": 60
  }
}
